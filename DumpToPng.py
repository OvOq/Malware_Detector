import numpy, scipy, os, array
import imageio
import matplotlib.pyplot as plt

# 一些参数
# filename = 'E:/0/test1.dmp'
# graphname = 'E:/0/test1.png'
threshold = 4 * 1048576 # 文件长度以4MB为阈值

def DumpToPng(filepath):
    "遍历文件夹, 扫描.dmp文件并转为同名灰度图存到文件夹新的同级目录下"
    # print(filepath)
    # print(type(filepath))
    for root, dirs, files in os.walk(filepath):
        # print(files)
        for file in files:
            # 获取文件名和一些参数
            str(file)
            fname = file.split('.dmp')[0]                    # 注意类型转换,不加下标则是list
            filename = filepath + fname + '.dmp'
            graphname = 'E:/0/' + fname + '.jpg'             # 原来格式是png

            # print(fname)
            # print(type(fname))
            print(filename)

            # 读文件信息
            f = open(filename, 'rb')                
            len = os.path.getsize(filename)

            print('文件大小: %dB' % len)

            # w的选择: 文件大于4MB,w=4096; 否则2048
            if len > threshold:
                wid = 4096
            else:
                wid = 2048

            high = int(len / wid)                  # 一维数组数
            rem = len%wid                          # 剩余的字节
            if high == 0:
                high = 1
            
            # 将数组转为二维
            a = array.array("B") # uint8
            a.fromfile(f, len-rem)
            f.close()

            g = numpy.reshape(a, (high, wid))
            g = numpy.uint8(g)

            # 保存图片
            # scipy.misc.imsave(graphname, g)
            imageio.imsave(graphname, g)

    return

DumpToPng(filepath = 'E:/00/')
# DumpToPng(filepath = 'E:/dump_vir/')