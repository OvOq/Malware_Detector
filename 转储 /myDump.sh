source_dir='/home/lyl/.cuckoo/storage/analyses/'
destination_dir='/media/lyl/Xdisk/dump_v_bcdoor/'
dmp_dir='/media/lyl/Xdisk/dump_worm/'
bio_dir='/home/lyl/.cuckoo/storage/binaries/'
mincount=3
while true
do
  echo "外层循环"
  for i in $(ls $source_dir); do
    # echo $mycount
    # 遍历已经分析过的文件
    filecount=$(ls $source_dir | wc -l)
    echo $filecount
    if [ $filecount -lt $mincount ]; then
      echo "文件数量不足，等待"
      sleep 300
      break;
    fi
    if [ "${i}"x = "latest"x ]; then
      echo "没有文件，等待"
      break;
    fi
    echo $i

    # 1. 利用volatility从dump中提取出进程的内存
    # 1.1 先找进程的pid，从analysis.log文件中提取程序的pid
    ana_dir=$source_dir$i"/analysis.log"
    mem_dir=$source_dir$i"/memory.dmp"
    cat $ana_dir | while read line
    do
      echo "$line"
      str=$line
      OLD_IFS="$IFS"
      IFS=" "
      arr=($str)
      IFS="$OLD_IFS"
      
      myPidTag=${arr[2]}
      echo $myPidTag
      if [ "${myPidTag}"x = "[lib.api.process]"x ]; then
        myPid=${arr[15]}
        strv=${arr[9]}

        # 1.1.1 这一步主要是因为当时挂载在\的空间不够了，想一切办法清理文件
        # 1.1.1.1 内存取证之后删除数据库中的二进制文件（内存够时不推荐！）
        OLD_IFS="$IFS"
        IFS='\'
        array=($strv)
        IFS="$OLD_IFS"
        prename=${array[6]}
        
        # 1.1.1.2 去除文件名后的特殊字符
        OLD_IFS="$IFS"
        IFS="\'"
        array2=($prename)
        IFS="$OLD_IFS"
        virusname=${array2[0]}
        
        echo $i
        echo $myPid
        echo $virusname
        
        # 用volatility提取恶意程序的内存转储
        volatility -f $mem_dir --profile=Win7SP1x64 memdump -p $myPid -D $dmp_dir

        # 改文件名以防重复
        mv $dmp_dir$myPid".dmp" $dmp_dir$i"_"$myPid".dmp"
        # 1.1.1.3 删除二进制文件
        rm -rf $bio_dir$virusname
      fi
    done
    # 删除分析过的文件夹以防占内存
    rm -rf $source_dir$i
  done
done
