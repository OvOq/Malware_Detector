source_dir='/home/lyl/.cuckoo/storage/analyses/'
destination_dir='/media/lyl/Xdisk/dump_v_bcdoor/'
dmp_dir='/media/lyl/Xdisk/dump_bcdoor/'
while true
do
  mycount=3
  tag=0
  for i in $(ls $source_dir | sort -g); do
    # echo $mycount
    # 遍历已经分析过的文件
    if [ $mycount -eq $tag ]; then 
      echo "处理完毕，等待计算结果"
      sleep 2400
      break; 
    fi
    mycount=$(($mycount-1))
    if [ "${i}"x = "latest"x ]; then
      continue;
    fi
    echo $i

    # 1. 利用volatility从dump中提取出进程的内存
    # 1.1 先找进程的pid，从analysis.log文件中提取程序的pid
    ana_dir=$source_dir$i"/analysis.log"
    mem_dir=$source_dir$i"/memory.dmp"
    cat $ana_dir | while read line
    do
      echo "$line"
      str=$line
      OLD_IFS="$IFS"
      IFS=" "
      arr=($str)
      IFS="$OLD_IFS"
      
      myPidTag=${arr[2]}
      echo $myPidTag
      if [ "${myPidTag}"x = "[lib.api.process]"x ]; then
        myPid=${arr[15]}
        echo $myPid
        # volatility -f $mem_dir --profile=WinXPSP2x86 -p $myPid -D $dmp_dir
        volatility -f $mem_dir --profile=Win7SP1x64 memdump -p $myPid -D $dmp_dir
      fi
    done
    # 内存dmp文件转移
#    for j in $(ls $source_dir$i"/memory/"); do
#      if [ "${j##*.}"x = "dmp"x ]; then
#        echo $j 
#        mv $source_dir$i"/memory/""/""$j" $destination_dir"$i-$j"  
#      fi
#    done
#    rm -rf $source_dir$i
  done
done
