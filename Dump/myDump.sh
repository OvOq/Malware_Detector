source_dir='/home/lyl/.cuckoo/storage/analyses/'
destination_dir='/media/lyl/Xdisk/dump_v_bcdoor/'
dmp_dir='/media/lyl/Xdisk/dump_bcdoor/'
mincount=3
while true
do
  echo "外层循环"
  for i in $(ls $source_dir); do
    # echo $mycount
    # 遍历已经分析过的文件
    filecount=$(ls $source_dir | wc -l)
    echo $i
    echo $filecount
    if [ $filecount -lt $mincount ]; then
      echo "文件数量不足，等待"
      sleep 300
      break;
    fi
    if [ "${i}"x = "latest"x ]; then
      echo "没有文件，等待"
      break;
    fi
    echo $i

    # 1. 利用volatility从dump中提取出进程的内存
    # 1.1 先找进程的pid，从analysis.log文件中提取程序的pid
    ana_dir=$source_dir$i"/analysis.log"
    mem_dir=$source_dir$i"/memory.dmp"
    cat $ana_dir | while read line
    do
      echo "$line"
      str=$line
      OLD_IFS="$IFS"
      IFS=" "
      arr=($str)
      IFS="$OLD_IFS"
      
      myPidTag=${arr[2]}
      echo $myPidTag
      if [ "${myPidTag}"x = "[lib.api.process]"x ]; then
        myPid=${arr[15]}
        echo $myPid
        volatility -f $mem_dir --profile=Win7SP1x64 memdump -p $myPid -D $dmp_dir
        # 改文件名以防重复
        mv $dmp_dir$myPid".dmp" $dmp_dir$i"_"$myPid".dmp"
      fi
    done
    rm -rf $source_dir$i
  done
done
